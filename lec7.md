# Lec7: 存储器层次结构
## 存储器概述
### 基本术语
- 记忆单元/存储元（Cell）：具有两种稳态的能够表示二进制数码0和1的物理器件
- 存储单元（Addressing Unit）：具有相同地址的位构成一个存储单元，也称为一个编址单位
- 存储体/ 存储矩阵/ 存储阵列（Bank）：**所有存储单元**构成一个存储阵列
- 编址方式（Addressing Mode）：按字节编址、按字编址
- 存储器地址寄存器（Memory Address Register -MAR）：用于存放**主存单元地址**的寄存器
- 存储器数据寄存器（Memory Data Register-MDR）：用于存放主存单元中的**数据**的寄存器

### 存储器分类
（1）按工作性质/存取方式分类
- 随机存取存储器 RandomAccessMemory(RAM)
按地址访问，每个单元的读写时间一样且与单元所在位置无关，比如内存

- 顺序存取存储器 SequentialAccess Memory(SAM)
数据按顺序从存储载体的始端读入或写出，存取时间的长短与信息所在位置有关，比如磁带

- 直接存取存储器 DirectAccessMemory(DAM)
直接定位到读写数据块，在读写数据块时按顺序进行。如磁盘。

- 相联存储器 AssociateMemory(AM)，Content Addressed Memory (CAM)
按内容检索到存储位置进行读写。例如：快表

（2）按存储介质分类
半导体存储器：双极型，静态MOS型，动态MOS型
磁表面存储器：磁盘（Disk）、磁带（Tape）
光存储器：CD，CD-ROM，DVD

（3）按信息的可更改性分类
读写存储器（Read / Write Memory）：可读可写
只读存储器（Read Only Memory）：只能读不能写

（4）按断电后信息的可保存性分类
非易失（不挥发）性存储器(Nonvolatile Memory) 
信息可一直保留， 不需电源维持。
（如：ROM、磁表面存储器、光存储器等）
易失（挥发）性存储器(Volatile Memory)
电源关闭时信息自动丢失。（如：RAM、Cache等）

（5）按功能/容量/速度/所在位置分类
离CPU越近，速度越快
- 寄存器(Register)
• 封装在CPU内，用于存放当前正在执行的指令和使用的数据
• 用触发器实现，**速度快**，容量小（几kB）

- 高速缓存(Cache)
• 位于CPU内部或附近，用来存放当前要执行的局部程序段和数据
• 用SRAM实现，速度可与CPU匹配，容量小（几MB）

- 主存储器MM（Main(Primary) Memory）
• 位于CPU之外，用来存放已被启动的程序及所用的数据
• 用DRAM实现，速度较快，容量较大（几GB）

- 外存储器AM(辅助存储器Auxiliary/Secondary Storage)
• 位于主机之外，用来存放暂不运行的程序、数据或存档文件
• 用磁表面或光存储器实现，容量大而速度慢

### 内存和外存关系及比较
![1763015341642](image/lec7/1763015341642.png)

### 主存
主存中主要存放指令及其数据！CPU执行指令时需要取指令、取数据、存数据，这个时候会访问主存。
![1763015439856](image/lec7/1763015439856.png)
![1763015492413](image/lec7/1763015492413.png)

### 存储区层次化结构
为了缩小存储器和处理器两者之间在性能方面的差距，通常在计算机内部采用**层次化的存储器体系结构**。
![1763015524674](image/lec7/1763015524674.png)
速度越快，容量越小，越靠近CPU
CPU可以直接访问内部存储器，而外部存储器需要先被取到主存，再被CPU访问
数据一般只在**相邻层之间**复制传输，而且总是从慢速存储器复制到快速存储器。

## 半导体随机存取存储器
### 六管静态MOS管存储元件
动态还是静态：数据是否需要周期性刷新
静态RAM（SRAM）中数据保存在一对正负反馈门电路中，只要供电，数据就一直保持，不是破环性读出，也无需重写，即无需刷新！
看作带时钟的RS触发器
![1763015921466](image/lec7/1763015921466.png)

### 单管动态MOS管存储元件
![1763015985852](image/lec7/1763015985852.png)
通过电容的充电放电的电流来判断是0还是1
动态RAM（DRAM）中数据保存在电容器中，由于电容器有漏电现象，存储的数据会随着时间的推移而逐渐消失，因此需要周期性地刷新（读出后重新写回）。

### 两种RAM的比较
![1763016110230](image/lec7/1763016110230.png)
![1763016297859](image/lec7/1763016297859.png)
这里的“芯片”是实现数据存储的集成电路器件，通过上述模块配合完成 “存数据、取数据” 的功能

### CPU与存储器之间的通信方式
有异步和同步两种通信方式
![1763017914170](image/lec7/1763017914170.png)

### SDRAM芯片技术
SDRAM是**同步存储芯片**
- 每步操作都在**系统时钟控制下**进行
- 有确定的等待时间（读命令开始到数据线有效的时间, 称为CAS潜伏期）CL，例如CL=2 clks
- 连续传送（Burst）数据个数BL=1 / 2 / 4 / 8
- 多体(缓冲器)交叉存取
- 利用总线时钟上升沿与下降沿同步传送
![1763017998503](image/lec7/1763017998503.png)
- DDRSDRAM技术：每个时钟内传送两个数据
- DDR2SDRAM技术：每个时钟内传送4个数据
- DDR3SDRAM：每个时钟内传送8个数据

### 内存条和内存条插槽
内存条：把若干片DRAM芯片焊在一小条电路板上
内存条插槽：存储器总线
内存条必须插在主板上的内存条插槽中才能使用（相同颜色插槽可以并行传输）
![1763018215331](image/lec7/1763018215331.png)
SIMM是内存条，Slot是内存条插槽，memory bus是内存总线


### 存储器芯片的扩展
核心是通过**组合多个小容量芯片**，得到更大容量或者更多位数的存储器
- 字扩展：每个芯片的字长相同，但是地址总线宽度增加，从而可以访问更多的地址
例子：用16K×8位芯片做64K×8位存储器
需4个芯片（容量从16K→64K，扩4倍）；每个芯片对应不同地址段（比如 0000-3FFFH、4000-7FFFH 等），靠 “片选信号” 选不同芯片。
- 位扩展：每个芯片的字长增加，但是地址总线宽度相同，从而可以访问更多的数据位
例子：用4096×1位芯片做4K×8位存储器
需8个芯片（位数从1位→8位扩8倍）；所有芯片地址范围相同，数据端**各自负责1位**，合起来是8位。
- 字位同时扩展：每个芯片的字长增加，地址总线宽度也增加，从而可以访问更多的地址和数据位
例子：用16K×4位芯片做64K×8位存储器
需8个芯片（容量扩4倍、位数扩2倍，4×2=8）；先按位扩（2个芯片凑8位），再按字扩（4组这样的芯片凑64K容量）

有两种容量扩展方式：交叉编址和连续编址。上述例子都是连续编址。

### DRAM芯片的扩展
![1763610043825](image/lec7/1763610043825.png)
由8片DRAM芯片构成
芯片内地址是否连续？
不连续，交叉编址，可同时读写所有芯片。

主存地址和片内地址有何关系？
主存地址27位，片内地址24位，与高24位主存地址相同。

主存低3位地址的作用是什么？
确定8个字节中的哪个，即用来选片。
![1763610110227](image/lec7/1763610110227.png)
![1763610159722](image/lec7/1763610159722.png)
![1763610197716](image/lec7/1763610197716.png)

### 多模块存储器
2个、4个或多个存储器同时工作
![1763610314714](image/lec7/1763610314714.png)
包含多个小体；每个体有其自己的MAR、MDR和读写电路；可独立组成一个存储模块；可同时对多个模块进行访问。

#### 连续编址方式
![1763610352817](image/lec7/1763610352817.png)
从某单元开始，连续在同一模块访问，然后才跳到下一个模块。

#### 交叉编址方式
![1763610377833](image/lec7/1763610377833.png)
能够提高吞吐率，在模块间交替进行

如果所有存储模块一次并行读写的总位数正好等于存储器总线中的数据位数，则可以采用**同时启动**方式。
每个存储模块一次读写的位数（即存储字）正好等于存储器总线中的数据位数（即总线传输单位），则采用**轮流启动**方式；
![1763610453836](image/lec7/1763610453836.png)
具有m个体的多模块存储器，每隔1/m个存储周期启动一个体，存取速度提高m倍。

## 外部辅助存储器
### 磁盘存储器
![1763618767677](image/lec7/1763618767677.png)
- 写入1：线圈通以正向电流，使呈N-S状态
- 写入0：线圈通以负向电流，使呈S-N状态
- 读取：磁头固定不动，载体运动。因为载体上小的磁化单元外部的磁力线通过磁头铁芯形成闭合回路，在铁芯线圈两端得到感应电压。根据感应电压的不同的极性，可确定读出为0或1。
![1763618837851](image/lec7/1763618837851.png)
早期扇区大小是512字节。但现在已经迁移到更大、更高效的**4096字节扇区**，通常称为**4K扇区**

#### 磁盘的内部逻辑结构
##### 寻道操作
![1763618906850](image/lec7/1763618906850.png)
来自或送到磁盘控制器的命令（写命令、读命令、盘地址等）会触发磁头定位伺服系统进行**寻道**。
“寻道” 指的是将磁头移动到目标**磁道**正上方的**机械运动过程**
寻道结束后，等待目标扇区旋转到磁头下方，也就是旋转等待操作。

##### 旋转等待操作
![1763619115694](image/lec7/1763619115694.png)
扇区计数器 会持续追踪当前经过磁头的是哪个扇区
磁盘地址寄存器 中存放着本次操作的目标地址（包括目标扇区号）。
扇区符合比较器 会持续将扇区计数器的当前值，与地址寄存器中的目标扇区号进行比较。
当两个值匹配时，比较器会发出 “扇区符合” 信号，进入读写操作。

##### 读写操作
![1763619191950](image/lec7/1763619191950.png)

#### 磁盘存储器的性能指标
