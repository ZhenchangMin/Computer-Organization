# Lec5: 中央处理器
## CPU概述
CPU执行指令的过程：取指、译码、执行、回写
取指令一定在最开始做，然后在执行之前译码
![1760594652740](image/lec5/1760594652740.png)
异常是CPU内部发生，中断是外部事件引起
![1760595197603](image/lec5/1760595197603.png)
![1760595709213](image/lec5/1760595709213.png)

### CPU基本组成
![1760595419656](image/lec5/1760595419656.png)
CPU包含：
- 数据通路(执行部件) 
- 控制器（控制部件）

#### 控制器
对指令进行**译码**，生成指令对应的**控制信号**，控制数据通路的动作。能对执行部件发出控制信号，是指令的**控制部件**

#### 数据通路
指令执行过程中，数据**所经过的路径，包括路径中的部件**。它是指令的**执行部件**。

数据通路是由操作元件和存储元件通过**总线方式或分散方式**连接而成的进行数据存储、处理、传送的路径。
数据通路由组合逻辑元件（操作元件）和时序逻辑元件（状态元件，存储元件）组成
- 组合逻辑元件与时钟信号无关，直接进行操作
- 时序逻辑元件受时钟信号控制，时钟信号到来时状态改变，写入元件状态；未到来时就可以存储

数据通路的功能就是进行数据存储、处理和传送。

##### 操作元件
比如加法器、多路选择器、ALU、译码器等等
组合逻辑元件的特点：
- 其输出只取决于当前的输入。即：**若输入一样**，则其输出也一样
- 定时：所有输入到达后，经过一定的逻辑门延时，输出端改变，并保持到下次改变，**不需要时钟信号来定时**

##### 状态元件
具有**存储功能**，在时钟控制下输入被写到电路中，直到下个时钟到达，输入端状态**由时钟决定何时被写入**，输出端状态**随时可以读出**

定时方式：规定信号何时写入状态元件
通常采用**边沿触发**方式
![1760596161535](image/lec5/1760596161535.png)
最简单的状态单元：
- D触发器：一个时钟输入、一个状态输入、一个状态输出
![1760596255848](image/lec5/1760596255848.png)
这是一个D触发器例子，D读取，Q输出
输入D的数据要在时钟到达之前就稳定，在到达之后也要保持一段时间稳定，在Clock-to-Q之后Q的值和D保持一致
因此是有延迟存在的

状态元件通常有寄存器和存储器两种
- 寄存器：有一个写使能信号（WE），当他是0的时候时钟边沿到来但是输出不变，如果是1那么输出开始变为输入，如果每个时钟边沿都写入就不需要WE
- 寄存器组：两个读口，一个写口
![1760596707172](image/lec5/1760596707172.png)
取数时间并不是锁存延迟，而是寄存器组的延迟
RW选择的寄存器会置为1，这样他和输入的busW进行与操作之后就可以知道哪一个是指定的寄存器

- 存储器：有一个Data out，一个Data in，一个地址 address
- 读操作：地址address有效之后，经过取数时间，data out上的数据变为有效
- 写操作：写使能信号为1，时钟边沿到来，data in传来的值写入address指定的存储单元中

### 现代计算机的时钟周期
什么是指令周期？ 取并且执行一条指令的时间

那么什么是时钟周期？
一个下降沿（上升沿）到下一个下降沿（上升沿）的时间
在时钟周期之中，经过锁存时间，状态元件读入数据，操作元件进行运算，再传递到下一个状态元件，这之中是没有时钟控制的
因此时钟周期=锁存延迟+最长传输延迟+建立时间（setup）+时钟偏移

约束条件：存延迟+最短传输延迟-时钟偏移 必须大于保持时间，才可以保证数据在时钟边沿到来时保持稳定 最小最小要大于保持时间

## 单周期处理器设计
![1760598203687](image/lec5/1760598203687.png)
处理器设计涉及到**数据通路**的设计和**控制器**的设计
对MIPS的三种指令格式，要实现对应的数据通路，用RTL表示
![1760598288025](image/lec5/1760598288025.png)

### 加法指令
![1760598439253](image/lec5/1760598439253.png)
先从PC所指的内存单元中取出这个指令，然后从rs和rt指的寄存器中取数之后相加
如果结果不溢出，就存进rd所指的寄存器中
最后PC+4，使得他指向下一条指令
RTL主要是描述数据通路的行为，表示相应的立即数或者寄存器

### 装入指令
![1760598470221](image/lec5/1760598470221.png)

### 取指令部件
每条指令都有的公共操作：取指令和PC+4，如果指令里面有修改PC的值就直接更新，因此不能先更新PC之后取指令
![1760598607450](image/241880334_闵振昌_25FA3/1760598607450.png)
下地址计算的逻辑部件会更新PC，在下一个时钟边沿触发的时候更新
如果是分支或者跳转指令，就不是PC+4，下地址逻辑部件就会计算相应的PC值

### 数据通路的设计
#### 加法和减法指令（R型）
不考虑公共操作先，只考虑指令执行阶段
![1760598805178](image/lec5/1760598805178.png)
先不看粉红色的线，RegWr是写使能信号，如果是1就把busW写入rd指的寄存器中
黑色的线就是R型指令的数据通路
ALUctr是ALU的控制信号，用来选择ALU的操作，比如我可以选ALUctr=add

#### 带立即数的逻辑指令（ori指令）
![1760598956691](image/lec5/1760598956691.png)
注意，这里的立即数是零扩展而不是符号扩展！
![1760598993076](image/lec5/1760598993076.png)
![1760599038860](image/lec5/1760599038860.png)
黑色的线就是刚才R型的数据通路，需要增加蓝色部分来支持逻辑运算
都是通过多路选择器来实现选择
RegDst是选择写回的寄存器，0是写回rd，1是写回rt
ALUctr是ALU的控制信号，用来选择ALU的操作，比如我可以选ALUctr=or
ALUSrc是选择ALU的第二个操作数，0是从busB取数，1是从立即数取数

#### 访存指令中的数据装入指令 (lw指令)
![1760599249229](image/lec5/1760599249229.png)
